<head>
      <title>User</title>
      <script src="buidl.js"></script>

</head>

<Body>

      <div style="width: 100%;margin: 0px 10px;">

            <h1>User Ares</h1>

            <div class="box row">
                  <div class="col5 step">
                        <h2>Sign up</h2>
                        <label for="">Name</label>
                        <input type="text" name="" id="name1">
                        <br>
                        <label for="">Password</label>
                        <input type="text" name="" id="pass1">
                        <br>
                        <button class="fr" onclick="signup()">Sign up</button>
                  </div>
                  <div class="col5 step">
                        <h2>Login</h2>
                        <label for="">Name</label>
                        <input type="text" name="" id="name2">
                        <br>
                        <label for="">Password</label>
                        <input type="text" name="" id="pass2">
                        <br>
                        <button class="fr" onclick="login()">login</button>
                  </div>
            </div>
            <br>
            <br>
            <div class="box" id="userInfo" style="display: none;">
                  <h2>User info:</h2>
                  <div class="row">
                        <div class="step col5">
                              <h4 for="">User Id:</h4>
                              <label for="" id="uid"></label>
                              <br>
                              <h4 for="">User name:</h4>
                              <label for="" id="uname"></label>
                        </div>
                        <div class="step col5">

                              <h4 for=""> User wallet address:</h4>
                              <label for="" id="walAdr">dvsdfv </label>
                              <br>
                              <h4 for=""> Wallet Balance:</h4>
                              <label for="" id="balance">
                                    <img src="ld.gif" alt=""> </label>
                              <br>
                        </div>
                  </div>
                  <div class="row">
                        <div class="step col5">
                              <h4 for="">Address total transactions:</h4>
                              <label for="" id="n_tx"></label>
                              <br>
                              <h4 for="">Address transaction Ids:</h4>
                              <div id="txrefs"></div>
                        </div>
                        <div class="step col5">

                              <h2>Send BTC:</h2>
                              <label for="">Out Address:</label>
                              <input type="text" name="" id="outAdr">
                              <br>
                              <label for="">Send Amount: <span>In Satushi</span></label>
                              <input type="number" name="" id="outAmount">
                              <br>
                              <label for="">Gass Fee: <span>In Satushi</span></label>
                              <input type="number" name="" id="gassFee">
                              <br>
                              <br>
                              <label for="">Total: &nbsp;&nbsp;<span id="total"> </span>&nbsp;&nbsp;Satushi</label>
                              <br>
                              <button class="fr" onclick="create()">Send</button>
                        </div>
                  </div>
            </div>

      </div>
      <script src="https://code.jquery.com/jquery-3.6.4.js"
            integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"
            integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

      <script>
            function writeTotal() {
                  var amount = (Number(document.getElementById('outAmount').value));
                  var fee = (Number(document.getElementById('gassFee').value));
                  var total = amount + fee;
                  $("#total")[0].innerHTML = total
            }
            document.getElementById('outAmount').addEventListener('input', writeTotal)
            document.getElementById('gassFee').addEventListener('input', writeTotal)


            var latestTX = '';
            var currentAddress = '';
            var currentBalance = 0;
            var isInputIndexFetched = false;
            var outni = 0;

            function create() {
                  console.log('currentAddress: ' + currentAddress)
                  console.log('latestTX: ' + latestTX)
                  var typei = currentAddress.substr(0, 1)
                  var txidi = latestTX;
                  getTXOutIndex(latestTX, currentAddress)
                  var sent = false;
                  var inn = setInterval(() => {
                        if (isInputIndexFetched) {
                              if (!sent) {



                                    var outputi = document.getElementById('outAdr').value;
                                    var amounti = (Number(document.getElementById('outAmount').value));
                                    var fee = (Number(document.getElementById('gassFee').value))
                                    var TX = {
                                          typei: typei,
                                          txidi: txidi,
                                          outni: outni,
                                          outputi: outputi, //It's the Out Address
                                          amounti: amounti,
                                          outValue: outValue,
                                          fee: fee,
                                          userId: document.getElementById('uid').innerHTML,
                                          userName: document.getElementById('uname').innerHTML,
                                          userBalance: currentBalance,
                                          userAddress: currentAddress,
                                    }


                                    var res = $.cookie('TXReq');
                                    console.log(typeof (res))
                                    console.log(res)
                                    res = JSON.parse(res)

                                    console.log(typeof (res))
                                    console.log(res)
                                    //var res2 = new Array;
                                    //res2.push(res)
                                    // console.log(typeof (TX))
                                    // console.info(TX)
                                    // console.info(JSON.stringify(TX))

                                    res.push(TX)
                                    console.log(typeof (res))
                                    console.log(res)
                                    console.info(res)
                                    setX('TXReq', JSON.stringify(res))

                                    sent = true;
                              } else {
                                    clearInterval(inn)
                              }
                        }
                  }, 2000);
                  //var wifi = document.getElementById('wifi').value;
                  // var changeout = document.getElementById('changeout').value;
                  // var changeamt = document.getElementById('changeamt').value;
                  // var inputvalue = document.getElementById('inputvalue').value;
                  // var typei = document.getElementById('typei').value;
                  // if (document.getElementById('testnetbox').checked == true) {
                  //       res = buidl.createTransaction(typei, txidi, Number(outni), outputi.toString(), Number(amounti), wifi, null, null, null, 'testnet')
                  // } else {
                  //}

            }

            var outValue = 0;
            function getTXOutIndex(txid, adr) {
                  //txid = 'bc82df1d3538f541bbad640b105472e6560cd2dea8138068e91765e8b6293d93';
                  $.get('https://api.blockcypher.com/v1/btc/main/txs/' + txid).then(function (d) {
                        console.log(d)
                        var outputs = d.outputs;
                        for (let i = 0; i < outputs.length; i++) {
                              //console.log(i + ' Is: ' + outputs[i].addresses[0]);
                              if (outputs[i].addresses[0] == adr) {
                                    isInputIndexFetched = true;
                                    outValue = Number(outputs[i].value)
                                    outni = i;
                                    return i, value;
                              }

                        }
                  });
            }
            function signup() {
                  var name = document.getElementById('name1').value;
                  var pass = document.getElementById('pass1').value;
                  if (name == '' || pass == '') {
                        window.alert(' Please enter a valid input')
                  } else {
                        var count = Number($.cookie('userCount')) || 1
                        var id = count + 1;
                        var userWA = buidl.fromXpub('zpub6rG9GphBhZWCWUfqwKpRJgMqhwjXhZrXFev4hYYifXYGZoUmiUujYMZbysGB6umAssDgWo9riWUNen6B5nTbAhHCMgK2DxQ15p4vfU8MEGK', 0, id).addr;
                        var User = {
                              id: id.toString(),
                              name: name,
                              password: pass,
                              wa: userWA
                        }

                        var users = JSON.parse($.cookie('allUsers'))
                        users.push(User)
                        setX('allUsers', JSON.stringify(users))
                        setX('userCount', id)
                  }
            }

            function login() {
                  var name = document.getElementById('name2').value;
                  var pass = document.getElementById('pass2').value;
                  if (name == '' || pass == '') {
                        window.alert(' Please enter a valid input')
                  } else {
                        var users = JSON.parse($.cookie('allUsers'))
                        for (let i = 0; i < users.length; i++) {
                              if (users[i].name == name) {
                                    if (users[i].password == pass) {

                                          writeUser(users[i])
                                          return
                                    }
                                    window.alert('Wrong Password!')
                                    return
                              }

                        }
                        window.alert('User Not Found!')

                  }
            }
            function getBalance(adr) {
                  $.get('https://api.blockcypher.com/v1/btc/main/addrs/' + adr)
                        .then(function (d) {
                              console.log(d);
                              currentBalance = Number(d.balance);
                              var bal = currentBalance / (10 ** 8)
                              $('#balance')[0].innerHTML = bal + ' BTC'
                        });

            }
            function writeUser(user) {
                  $('#userInfo')[0].style.display = 'block'
                  $('#uid')[0].innerHTML = user.id;
                  $('#uname')[0].innerHTML = user.name;
                  //     $('#uname')
                  //user.wa = '13oYcuDn1Fr5bnSVn9H3jpUpzcEyJ7zKzF'
                  $('#walAdr')[0].innerHTML = user.wa;

                  getBalance(user.wa)
                  getTX(user.wa)
                  currentAddress = user.wa
            }

            function getTX(adr) {
                  console.log('get TX called')
                  $.get('https://api.blockcypher.com/v1/btc/main/addrs/' + adr)
                        .then(function (d) {
                              console.log(d)
                              //n_tx
                              $('#n_tx')[0].innerHTML = d.n_tx;
                              if (Number(d.n_tx) > 0) {


                                    var hss = '';
                                    // console.info(d.txrefs)
                                    // console.log(d.txrefs)
                                    var txs = d.txrefs
                                    console.info(txs)
                                    for (let i = 0; i < txs.length; i++) {
                                          hss += `
                                          <a target="_blank" href="https://live.blockcypher.com/btc/tx/${txs[i].tx_hash}">${txs[i].tx_hash}</a>
                                          `
                                          if (i == txs.length - 1) {
                                                latestTX = txs[i].tx_hash
                                          }
                                    }
                                    //txrefs
                                    $('#txrefs')[0].innerHTML = hss;
                              }


                        });
            }

            function setX(key, val) {
                  var expire = new Date();
                  //set expiry to current time plus 900 days
                  expire.setTime(expire.getTime() + (60 * 24 * 900 * 60 * 1000));
                  $.cookie(key, val, { expires: expire });
            }

            function init() {

                  setX('userCount', '-1')
                  setX('allUsers', JSON.stringify([]))
                  setX('TXReq', JSON.stringify([]))
            }


            function mt() {

                  for (let i = 0; i < 100; i++) {

                        var userWA = buidl.fromXpub('zpub6rG9GphBhZWCWUfqwKpRJgMqhwjXhZrXFev4hYYifXYGZoUmiUujYMZbysGB6umAssDgWo9riWUNen6B5nTbAhHCMgK2DxQ15p4vfU8MEGK', 0, i).addr;
                        if (userWA == 'bc1q9pwknsmr5jcuap4hm533ns0dztfdvuje0gs09x') {

                              console.info(userWA)
                              console.log('dr is: ' + i)

                        }

                  }

            }
      </script>
</Body>

<style>
      .box {
            border: 1px black solid;
            padding: 10px;
      }

      .step {
            background-color: #cccccc;
            padding: 10px;
      }

      .col5 {
            width: 44vw;
            margin: 1vw;
      }

      .row {
            display: inline-flex;
      }

      .fr {
            margin-top: 1vh;
            margin-left: 10vw;
      }

      .info {
            background-color: #f7e1e1;
            padding: 15px 2px;
      }

      label {
            display: flex;
            position: relative;
      }

      body {
            width: 100%;
            margin: 0px;
      }
</style>