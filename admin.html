<!DOCTYPE html>

<head>
      <title>Faxlix - Admin dashboard</title>
      <link rel="stylesheet" href="assets/css/fonts.css">
      <script src="buidl.js"></script>

</head>

<body>

      <h1>Admin dashborad</h1>

      <div class="box">
            <h2>All users:</h2>
            <table id="ut">
                  <tr>
                        <th>User Id</th>
                        <th>User Name</th>
                        <th>User wallet address</th>
                        <th>User balance</th>
                  </tr>

            </table>
      </div>
      <br>
      <div class="box">
            <h2>Transaction Requests:</h2>

            <table id="tx">
                  <tr>
                        <th>Index</th>
                        <th>User Id</th>
                        <th>User Name</th>
                        <th>Send Amount</th>
                        <th>Gas Fee</th>
                        <th></th>
                        <th></th>
                  </tr>
                  <!-- <tr>
                        <td>${username}</td>
                        <td>${username}</td>
                        <td>${username}</td>
                        <td>${username}</td>
                        <td>${username}</td>
                        <td><button class="acp" onclick="acceptTX()">Accept</button></td>

                  </tr> -->

            </table>
            <br>
            <div>
                  <textarea name="" id="detail" cols="80" rows="15"></textarea>
            </div>
      </div>
      <br>
      <br>
      <br>
      <br>
      <br>
      <div class="step">
            <p style="color:red;">*FOR LATER DEVELOPMENT:
                  <br>
                  1- Convert all values to SATUSHI.
                  <br>
                  2- A system for managing inputs and uotputs nad <b>CHANGES</b>
            </p>
      </div>
      <script src="https://code.jquery.com/jquery-3.6.4.js"
            integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"
            integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

      <script>
            var requests = new Array();
            function loadPTX() {
                  var c = $.cookie('TXReq');
                  console.info(c)

                  var TXReq = JSON.parse(c);
                  console.info(TXReq)
                  if (TXReq.length > 0) {
                        var rows = '';
                        for (let i = 0; i < TXReq.length; i++) {
                              requests.push(TXReq[i])
                              rows += `
                                                <tr>
                                    <td>${i}</td>
                                    <td>${TXReq[i].userId}</td>
                                    <td>${TXReq[i].userName}</td>
                                    <td>${Number(TXReq[i].amounti)} Satushi</td>
                                    <td>${Number(TXReq[i].fee)} Satushi</td>
                                    <td><button class="acp" onclick="showTX(${i})">Detail</button></td>
                                    <td><button class="acp" onclick="acceptTX(${i})">Accept</button></td>

                              </tr>
                                    `
                              console.log(rows)
                        }

                        $('#tx').append(rows)
                        //tx
                  }
            }
            function showTX(ind) {
                  var TXReq = JSON.parse($.cookie('TXReq'))
                  var text = JSON.stringify(TXReq[ind], null, 2);
                  $('#detail')[0].value = text;
                  //detail JSON.stringify(obj, null, 2);
            }

            var users = JSON.parse($.cookie('allUsers'))
            var row = '';
            var allRows = '';
            var allAddresses = ''
            for (let i = 0; i < users.length; i++) {

                  row = `<tr>
                        <td>${users[i].id}</td>
                        <td>${users[i].name}</td>
                        <td>${users[i].wa}</td>
                        <td class="center" id="bal-${users[i].wa}"><img class="sm" src="ld.gif" alt=""></td>
                  </tr>`
                  allRows += row;
                  if (i == users.length - 1) {
                        allAddresses += users[i].wa
                  } else {
                        allAddresses += users[i].wa + ';'
                  }
            }


            function acceptTX(ind) {x
                  var id = requests[ind].userId;
                  var senderAddress = requests[ind].userAddress
                  console.log(requests[ind]);
                  var zprv = window.prompt('Enter the full zprv key:');
                  var WIF = buidl.xprvToWIF(zprv, 0, id);
                  //WIF.wif = 'Kx5mS8xk6Masmum74ydFerGSdBZgDVRGNFxFKsoGwNXkT9ne72sU'
                  console.log(WIF);
                  var det = buidl.getDetails(WIF.wif)

                  console.info(det)
                  console.info(requests[ind].userAddress)

                  //"{"error": "Error validating transaction: Error running script for input 0 referencing bc82df1d3538f541bbad640b105472e6560cd2dea8138068e91765e8b6293d93 at 3: Script was NOT verified successfully.."}"

                  console.log(requests[ind].typei, requests[ind].txidi,
                        Number(requests[ind].outni), requests[ind].outputi.toString(),
                        Number(requests[ind].amounti) - 1000, WIF.wif, '13oYcuDn1Fr5bnSVn9H3jpUpzcEyJ7zKzF', 1000, 0)

                  if (det.p2wpkh == requests[ind].userAddress || true) {
                        var newTX = buidl.createTransaction(requests[ind].typei, requests[ind].txidi,
                              Number(requests[ind].outni) + 0, requests[ind].outputi.toString(),
                              Number(requests[ind].amounti), WIF.wif, 0, 0, Number(requests[ind].outValue))



                        console.info(newTX)
                        decodeTX(newTX, Number(requests[ind].amounti))

                  } else {
                        window.alert('Key is not corect!')
                  }

            }
            //Error validating transaction: Error running script for input 0 referencing bc82df1d3538f541bbad640b105472e6560cd2dea8138068e91765e8b6293d93 at 3: Script was NOT verified successfully..
            function decodeTX(mytx, amount) {
                  console.info(mytx)
                  var decodetx = {
                        tx: mytx.signedtx
                  };
                  $.post('https://api.blockcypher.com/v1/btc/main/txs/decode', JSON.stringify(decodetx))
                        .then(function (d) {
                              console.log(d)
                              console.log(d.total)
                              console.log(amount)
                              if (d.total == amount) {
                                    var conf = window.confirm('Transaction for ' + amount + ' Satushi is ready to broadcast. Sure to do so?')
                                    if (conf) {
                                          console.log('Broadcast start')
                                          var pushtx = {
                                                tx: mytx.signedtx
                                          };
                                          $.post('https://api.blockcypher.com/v1/btc/main/txs/push', JSON.stringify(decodetx))
                                                .then(function (s) {
                                                      console.log(s)
                                                      latestPush = s
                                                }).catch((f) => { console.log(f) });
                                    }
                              } else {
                                    console.log('err------')
                              }

                        });
            }

            $('#ut').append(allRows)
            console.info(allAddresses)
            getBalance(allAddresses);

            var latestPush = '';
            function getLatestPush() {
                  console.info(latestPush)
            }

            function getBalance(adrs) {
                  console.log('Calling for balances: ' + adrs)
                  $.get('https://api.blockcypher.com/v1/btc/main/addrs/' + adrs + '/balance')
                        .then((d) => {
                              var walAdrs = adrs.split(";");
                              console.log('bal cal then');
                              console.log(typeof (d));
                              console.info(d);
                              //=$('#balance')[0].innerHTML  d.balance
                              for (let i = 0; i < d.length; i++) {
                                    for (let j = 0; j < adrs.length; j++) {
                                          if (d[i].address == walAdrs[j])
                                                $('#bal-' + d[i].address)[0].innerHTML = d[i].balance
                                    }


                              }
                        }).catch((res) => {
                              console.info(res.responseText)
                              console.log(typeof (res))
                              var d = JSON.parse(c.responseText)
                              var walAdrs = adrs.split(";");

                              console.log(d);
                              for (let i = 0; i < d.length; i++) {
                                    for (let j = 0; j < adrs.length; j++) {
                                          if (d[i].address == walAdrs[j])
                                                $('#bal-' + d[i].address)[0].innerHTML = d[i].balance
                                    }
                              }
                        })
                  // .catch(function (c) {
                  //       console.info(c)
                  //       console.log('bal cal catch');
                  //       var d = JSON.parse(c.responseText)
                  //       console.log(d);
                  //       //=$('#balance')[0].innerHTML  d.balance
                  //       for (let i = 0; i < d.length; i++) {
                  //             for (let j = 0; j < adrs.length; j++) {
                  //                   if (d[i].address == adrs[j])
                  //                         $('#bal-' + d[i].address)[0].innerHTML = d[i].balance
                  //             }


                  //       }
                  // }
                  // );

            }

            loadPTX();
      </script>
</body>

<style>
      .sm {
            max-width: 24px;
      }




      td {
            padding: 4px 8px;
      }

      th {
            background-color: #cccbbb;
            padding: 4px 8px;


      }

      tr:nth-child(odd) {
            background-color: #dddddd;
      }

      .center {
            text-align: center;
      }

      .box {
            border: 1px black solid;
            padding: 10px;
      }

      .step {
            background-color: #cccccc;
            padding: 10px;
      }

      .col5 {
            width: 44vw;
            margin: 1vw;
      }

      .row {
            display: inline-flex;
      }
</style>